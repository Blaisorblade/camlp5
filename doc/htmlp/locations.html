<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN" 
 "http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
  <!-- $Id: locations.html,v 1.4 2007/07/27 02:04:04 deraugla Exp $ -->
  <!-- Copyright (c) 2007 INRIA -->
  <title>Locations</title>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <meta http-equiv="Content-Style-Type" content="text/css" />
  <link rel="stylesheet" type="text/css" href="styles/base.css"
        title="Normal" />
</head>
<body>

<div id="menu">
</div>

<div id="content">

<h1 class="top">Locations</h1>

<p>The location is a concept often used in camlp5, bound to know where
  the errors occur in the source. The basic type is
  "<tt>Stdpp.location</tt>" which is an abstract type.</p>

<div id="tableofcontents">
</div>

<h2>Definitions</h2>

<p>A location is internally a couple of source <em>positions</em>: the
  beginning and the end of an element in the source (file or
  interactive).  A located element can be a character (the end is just
  the beginning plus one), a token, or a longer sequence generally
  corresponding to a grammar rule.</p>

<p>A <em>position</em> is a count of characters since the beginning of
  the file, starting at zero. When a couple of positions define a
  location, the first position is the position of the first character
  of the element, and the last position is the first
  character <em>not</em> part of the element. The location length is
  the difference between those two numbers. Notice that the position
  corresponds exactly to the character count in the streams of
  characters.</p>

<p>In the <a href="grammars.html">extensible grammars</a>, a variable
  with the specific name "<tt>loc</tt>" is predefined in all semantic
  actions: it is the location of the associated rule. Since
  the <a href="ml_ast.html">syntax tree quotations</a> generate nodes
  with "<tt>loc</tt>" as location part, this allow to generate
  grammars without having to think about source locations.</p>

<p>It is possible to change the name "<tt>loc</tt>" into another name,
  through the parameter "<tt>-loc</tt>" of the camlp5 commands.</p>

<p>Remark: the reason why the type "<tt>location</tt>" is abstract is
  that in future versions, it may contain other informations, such as
  the associated comments, the type (for expressions nodes), things
  like that, without having to change the already written
  programs.</p>

<h2>Building locations</h2>

<p>Tools are provided in the module "<tt>Stdpp</tt>" to manage
  locations.</p>

<p>First, "<tt>Stdpp.dummy_loc</tt>" is a dummy location used when the
  element does not correspond to any source, or if the programmer does
  not want to busy about locations.</p>

<p>The function "<tt>Stdpp.make_lined_loc</tt>" builds a location from
  three parameters:</p>

<ul>
  <li>the line number, starting at 1</li>
  <li>the position of the first column of the line</li>
  <li>a couple of positions of the location: the first one belonging
    to the given line, the second one being able to belong to another
    line, further.</li>
</ul>

<p>If the line number is not known, it is possible to use the function
  "<tt>Stdpp.make_loc</tt>" taking only the couple of positions of the
  location. In this case, error messages may indicate the first line
  and a big count of characters from this line (actually from the
  beginning of the file). With a good text editor, it is possible,
  anyway to find the good location, anyway.</p>

<p>If the location is built with "<tt>Stdpp.make_loc</tt>", and if
  your program displays a source location itself, it is possible to
  use the function "<tt>Stdpp.line_of_loc</tt>" which takes the file
  name and the location as parameters and return, by reading that
  file, the line number, and the character positions of the
  location.</p>

<h2>Raising with a location</h2>

<p>The function "<tt>Stdpp.raise_with_loc</tt>" allows to raise an
  exception together with a location. It is the case of all exceptions
  raised in the <a href="grammars.html">extensible grammars</a>. The
  raised exception is "<tt>Stdpp.Exc_located</tt>" with two
  parameters: the location and the exception itself.</p>

<p>Notice that "<tt>raise_with_loc</tt>" just reraises the exception
  if it is already the exception "<tt>Exc_located</tt>", ignoring then
  the new given location.</p>

<p>A good usage to print exceptions possibly enclosed by
  "<tt>Exc_located</tt>" is to write the "<tt>try..with</tt>"
  statement like this:</p>

<pre>
  try ... with exn ->
    let exn =
      match exn with
      [ Stdpp.Exc_located loc exn -> do { ... print the location ...; exn }
      | _ -> exn ]
    in
    match exn with
    ...print the exception which is *not* located...
</pre>      

<h2>Other functions</h2>

<p>Some other functions are provided:</p>

<dl>
  <dt><tt>Stdpp.first_pos</tt></dt>
  <dd>returns the first position (an integer) of the location.</dd>
  <dt><tt>Stdpp.last_pos</tt></dt>
  <dd>returns the last position (an integer) of the location (position
    of the first character not belonging to the element.</dd>
  <dt><tt>Stdpp.line_nb</tt></dt>
  <dd>returns the line number of the location or <tt>-1</tt> if the
    location does not contain a line number (i.e. built by
    "<tt>Stdpp.make_loc</tt>").</dd>
  <dt><tt>Stdpp.bol_pos</tt></dt>
  <dd>returns the position of the beginning of the line of the
    location. It is zero if the location does not contain a line
    number (i.e. built by "<tt>Stdpp.make_loc</tt>").</dd>
</dl>

<p>And still other ones used in camlp5 sources:</p>

<dl>
  <dt><tt>Stdpp.encl_loc</tt></dt>
  <dd>"<tt>Stdpp.encl_loc loc1 loc2</tt>" returns the location
    starting at the smallest begin of "<tt>loc1</tt>" and
    "<tt>loc2</tt>" and ending at their greatest end.. In simple
    words, it is the location enclosing "<tt>loc1</tt>" and
    "<tt>loc2</tt>" and all what is between them.</dd>
  <dt><tt>Stdpp.shift_loc</tt></dt>
  <dd>"<tt>shift_loc sh loc</tt>" returns the location "<tt>loc</tt>"
    shifted with "<tt>sh</tt>" characters. The line number is not
    recomputed.</dd>
  <dt><tt>Stdpp.sub_loc</tt></dt>
  <dd>"<tt>Stdpp.sub_loc loc sh len</tt>" is the location
    "<tt>loc</tt>" shifted with "<tt>sh</tt>" characters and with
    length "<tt>len</tt>". The previous ending position of the
    location is lost.</dd>
  <dt>"<tt>Stdpp.after_loc</tt>"</dt>
  <dd>"<tt>Stdpp.after_loc loc sh len</tt>" is the location just after
    "<tt>loc</tt>" (i.e. starting at the end position of
    "<tt>loc</tt>"), shifted with "<tt>sh</tt>" characters, and of
    length "<tt>len</tt>".</dd>
</dl>

<div class="trailer">
</div>

</div>

</body>
</html>
