<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN" 
 "http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
  <!-- $Id: sources.html,v 1.4 2007/08/22 09:17:59 deraugla Exp $ -->
  <!-- Copyright (c) 2007 INRIA -->
  <title>Camlp5 sources</title>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <meta http-equiv="Content-Style-Type" content="text/css" />
  <link rel="stylesheet" type="text/css" href="styles/base.css"
        title="Normal" />
</head>
<body>

<div id="menu">
</div>

<div id="content">

<h1 class="top">Camlp5 sources</h1>

<p>Information for developpers of the Camlp5 program.</p>

<div id="tableofcontents">
</div>

<h2>Kernel</h2>

<p>The sources are composed of:</p>

<ul>
  <li>the ocaml stuff, copied from the ocaml compiler</li>
  <li>the <em>kernel</em> composed of the directories:
    <ul>
      <li>odyl : the dynamic loading system</li>
      <li>lib : the library</li>
      <li>main : the main program camlp5</li>
      <li>meta : the parsers for revised syntax, ast quotations,
        EXTEND statement, etc/</li>
    </ul>
  </li>
  <li>the rest: directories etc, compile, ocpp</li>
</ul>

<p>Some other directories contain configuration files, tools,
  documentation and manual pages.</p>

<p>The kernel is sufficient to make the core system work: it is possible
  to compile and bootstrap only it. All sources being in revised syntax,
  the first compilation of Camlp5 is done by a version of this kernel
  in pure ocaml syntax, located in the directory ocaml_src.</p>

<p>These sources in pure ocaml syntax are not modified by hand. When
  changes are done in the kernel, and when the check is done that it
  correctly compiles and bootstraps, the kernel in pure ocaml syntax
  is rebuilt using Camlp5 pretty print. This is done by the command
  "make bootstrap_sources".</p>

<h2>Compatibility</h2>

<p>This distribution of Camlp5 is compatible with several versions of
  ocaml. The problem is about the definition of ocaml syntax trees
  which may change from a version of ocaml to another. Since ocaml
  does not install the sources nor the compiled versions of its syntax
  tree, a copy of the necessary source files, borrowed from the source
  of the ocaml compiler has been done in the directory 'ocaml_stuff',
  in subdirectories with the ocaml version number.</p>

<p>If the present distribution of Camlp5 is not compatible with the
  version of ocaml you have (the command 'configure' tells you), it
  is possible to add it. For that, you need the sources of the ocaml
  distribution you have. Once done, after a 'configure' telling you
  that it is not compatible, do:</p>

<pre>
  make steal OCAML_SRC=&lt;path-to-ocaml-sources>
</pre>

<p>This creates a new directory in 'ocaml_stuff' with sources of the
  syntax tree of your ocaml compiler.</p>

<p>If you want to check that the sources of the syntax tree of ocaml
  are up-to-date (e.g. if this is the current ocaml developpement),
  do:</p>

<pre>
  make compare_stolen OCAML_SRC=&lt;path-to-ocaml-sources>
</pre>

<p>The compatibility is done also with the file 'main/ast2pt.ml',
  which is the module converting Camlp5 syntax tree into ocaml syntax
  tree.</p>

<p>In the directory 'ocaml_src' with containt the pure ocaml sources of
  the Camlp5 core (see chapter TREE STRUCTURE below), there are as versions
  of this files as version of ocaml. They are named 'ast2pt.ml_&lt;version>'.
  If you are adding a new version of ocaml, you need this file. In a first
  step, make a copy from a close version:</p>

<pre>
  cd ocaml_src/main
  cp ast2pt.ml_&lt;close_version> ast2pt.ml_&lt;version>
</pre>

<p>Then, you can redo "configure" and do "make core". If the file
  'ocaml_src/main/ast2pt.ml' has a compilation problems, fix them and
  to 'make core' again.</p>

<p>Later, the same file 'main/ast2pt.ml' in Camlp5 syntax may have
  similar compilation problem. This file is in one examplary, thanks
  to IFDEF used here or there.</p>

<p>While compiling with some specific version of ocaml, this file is
  compiled with 'OCAML_vers' defined where 'vers' is the version number
  form the beginning to the first space or charcter '+' with all dots
  converted into underscores. For example, if you ocaml version is
  7.04.2+dev35, you can see in the compilation process of ast2pt.ml
  that OCAML_7_04_2 is defined, and you can add statements defined
  by the syntax extension 'pa_macro.cmo', for example IFDEF OCAML_7_04_2.
  Add statements like that in 'main/ast2pt.ml' to make it compile.</p>

<h2>Tree structure</h2>

<p>The directory 'ocaml_src' contains images in pure ocaml syntax of the
  directories odyl lib main and meta. This allow to create a core version
  of Camlp5 from only the ocaml compiler installed.</p>

<p>You can decompose the building of the Camlp5 core into:</p>

<dl>
  <dt>1. make library_cold</dt>
  <dd>just makes the directory 'ocaml_src/lib' and copy the cmo and cmi
    files into the directory 'boot'</dd>
  <dt>2. make compile_cold</dt>
  <dd>makes the other directories of ocaml_src</dd>
  <dt>3. make promote_cold</dt>
  <dd>copies the executables "camlp5", "camlp5r" and the syntax
    extensions (cmo files) into the directory 'boot'</dd>
</dl>

<p>From that point, the core Camlp5 is in directory 'boot'. The real
  sources in the top directories odyl lib main and meta, which are
  written in revised syntax with some syntax extensions (grammars,
  quotations) can be compiled. To achieve their compilation, you can
  do:</p>

<pre>
  make core
</pre>

<p>Or to compile everything do:</p>

<pre>
  make all
</pre>

<p>or just:</p>

<pre>
  make
</pre>

<p>Notice that doing "make core" or "make all" from scratch (after a
  make clean), automatically starts by making the core files from
  their pure ocaml versions.</p>

<h2>Fast compilation from scratch</h2>

<pre>
  ./configure
  make clean core compare
  make coreboot
  make all opt opt.opt
</pre>

<h2>Testing changes</h2>

<p>1. do your changes</p>

<p>2. do:</p>

<pre>
  make core compare
</pre>

<p>if it says that the bootstrap is ok, you can do:</p>

<pre>
  make all
  make opt
  make opt.opt
</pre>

<p>otherwise, to make sure everything is ok, first do:</p>

<pre>
  make coreboot
</pre>

<p>sometimes two bootstraps ('make coreboot' twice) are necessary,
  in particular if you change things in the directory 'lib'. It is
  even possible that three bootstraps are necessary.</p>

<h2>Before committing your changes</h2>

<p>Make sure that the cold start with pure ocaml sources work. For
  that, do:</p>

<pre>
  make compare_sources | less
</pre>

<p>This shows you the changes that would be done in the ocaml pure sources
  of the directory ocaml_src.</p>

<p>To make the new versions, do:</p>

<pre>
  make new_sources
  make promote_sources
</pre>

<p>Notice that these pure ocaml sources are not supposed to be modified
  by hand, but only created by the above commands. Besides, their sources,
  although pretty printed, are sometimes not easy to read, particularly for
  expanded grammars (of the statement 'EXTEND').</p>

<p>However, if these sources do not compile, due to changes in the ocaml
  compiler, it is possible to edit them. In this case, similar changes
  may have to be done in the normal sources in revised syntax.</p>

<p>After doing 'make new_sources' above, and before doing 'make
  promote_sources' below, it is possible to do 'make untouch_sources'
  which change the dates of the new created files with the dates of the
  old files if they are not modified. This way, the "svn commit" will not
  have to compare these files, which may have some importance if you
  network is not fast.</p>

<p>The 'make new_sources' builds a directory named 'ocaml_src.new'.
  If this directory still exists, due to a previous 'make new_sources',
  the command fails. In this case, just delete it (rm -rf ocaml_src.new)
  without problem: this directory is not part of the distribution, it is
  just temporary.</p>

<p>The 'make clean_sources' deletes old versions of ocaml_src, keeping
  only the last and the before last ones.</p>

<p>The command:</p>

<pre>
  make bootstrap_sources
</pre>

<p>is a shortcut for:</p>

<pre>
  make new_sources
  make untouch_sources
  make promote_sources
  make clean_sources
</pre>

<p>If there are changes in the specific file 'main/ast2pt.ml', do
  also:</p>

<pre>
  make compare_all_ast2pt
</pre>

<p>and possibly:</p>

<pre>
  make bootstrap_all_ast2pt
</pre>

<p>because this file, in 'ocaml_src/main' directory has different
  versions according to the ocaml version.</p>

<p>After having rebuilt the pure ocaml sources, check they work by
  rebuilding everything from scratch, starting with "configure".</p>

<h2>If you change the main parser</h2>

<p>If you change the main parser 'meta/pa_r.ml', you may check that the
  quotations expanders of syntax tree 'meta/q_MLast.ml' match the new
  version. For that, do:</p>

<pre>
  cd meta
  make compare_q_MLast
</pre>

<p>If no differences are displayed, it means that 'q_MLast.ml' is ok,
  relatively to 'pa_r.ml'.</p>

<p>Otherwise, if the displayed differences seem reasonable, update the
  version by typing:</p>

<pre>
  make bootstrap_q_MLast
</pre>

<p>Then returning to the top directory, do 'make core compare' and
  possibly 'make coreboot' (one of several times) to check the
  correctness of the file.</p>

<p>And don't forget, if you want to commit, to re-create the pure ocaml
  sources like indicated above.</p>

<div class="trailer">
</div>

</div>

</body>
</html>
